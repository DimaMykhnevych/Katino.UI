<h1 mat-dialog-title>
  <div *ngIf="data.isAdding">
    {{ "adminFeatures.addingProductVariant" | translate }}
  </div>
  <div *ngIf="!data.isAdding">
    {{ "adminFeatures.updatingProductVariant" | translate }}
  </div>
</h1>
<div mat-dialog-content>
  <ng-container *ngIf="isRetrievingData">
    <app-spinner [diameter]="50"></app-spinner>
  </ng-container>
  <ng-container *ngIf="!isRetrievingData">
    <form [formGroup]="form">
      <div class="row mb-3">
        <div class="col-lg-5 col-md-5 col-10">
          <mat-form-field
            appearance="outline"
            class="w-100 product-variant-form-input"
          >
            <mat-label>{{ "inventory.product" | translate }}</mat-label>
            <mat-select formControlName="productId" required>
              <mat-option
                *ngFor="let product of productsResponse?.products ?? []"
                [value]="product.id"
              >
                {{ product.name }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="productId?.invalid && productId?.touched">
              {{ "validation.requiredField" | translate }}
            </mat-error>
          </mat-form-field>
        </div>
        <div
          class="col-lg-1 col-md-1 col-2 d-flex align-items-start justify-content-center pt-2"
        >
          <button
            class="action-button"
            mat-icon-button
            type="button"
            (click)="onAddEditProduct(data.isAdding)"
            [matTooltip]="
              data.isAdding
                ? ('common.add' | translate)
                : ('common.edit' | translate)
            "
          >
            <mat-icon>{{ data.isAdding ? "add" : "edit" }}</mat-icon>
          </button>
        </div>

        <div class="col-lg-5 col-md-5 col-10">
          <mat-form-field
            appearance="outline"
            class="w-100 product-variant-form-input"
          >
            <mat-label>{{ "inventory.size" | translate }}</mat-label>
            <mat-select formControlName="sizeId" required>
              <mat-option
                *ngFor="let size of sizesResponse?.sizes ?? []"
                [value]="size.id"
              >
                {{ size.name }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="sizeId?.invalid && sizeId?.touched">
              {{ "validation.requiredField" | translate }}
            </mat-error>
          </mat-form-field>
        </div>
        <div
          class="col-lg-1 col-md-1 col-2 d-flex align-items-start justify-content-center pt-2"
        >
          <button
            *ngIf="data?.isAdding"
            class="action-button"
            mat-icon-button
            type="button"
            (click)="onAddSize()"
            [matTooltip]="'common.add' | translate"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-5 col-md-5 col-10">
          <mat-form-field
            appearance="outline"
            class="w-100 product-variant-form-input"
          >
            <mat-label>{{ "inventory.color" | translate }}</mat-label>
            <mat-select
              formControlName="colorId"
              required
              (selectionChange)="onColorSelectionChange($event)"
            >
              <!-- Custom trigger to show color preview in the selected value -->
              <mat-select-trigger>
                <ng-container *ngIf="getSelectedColor() as selectedColor">
                  <div class="color-option">
                    <span
                      class="color-preview"
                      [style.background-color]="selectedColor.hexCode"
                    ></span>
                    <span class="color-name">{{ selectedColor.name }}</span>
                  </div>
                </ng-container>
              </mat-select-trigger>

              <!-- Options in dropdown -->
              <mat-option
                *ngFor="let color of colorsResponse?.colors ?? []"
                [value]="color.id"
              >
                <div class="color-option">
                  <span
                    class="color-preview"
                    [style.background-color]="color.hexCode"
                  ></span>
                  <span class="color-name">{{ color.name }}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-error *ngIf="colorId?.invalid && colorId?.touched">
              {{ "validation.requiredField" | translate }}
            </mat-error>
          </mat-form-field>
        </div>
        <div
          class="col-lg-1 col-md-1 col-2 d-flex align-items-start justify-content-center pt-2"
        >
          <button
            class="action-button"
            mat-icon-button
            type="button"
            (click)="onAddEditColor(data.isAdding)"
            [matTooltip]="
              data.isAdding
                ? ('common.add' | translate)
                : ('common.edit' | translate)
            "
          >
            <mat-icon>{{ data.isAdding ? "add" : "edit" }}</mat-icon>
          </button>
        </div>

        <div class="col-lg-5 col-md-5 col-10">
          <mat-form-field
            appearance="outline"
            class="product-variant-form-input"
          >
            <mat-label>{{ "inventory.status" | translate }}</mat-label>
            <mat-select
              formControlName="status"
              required
              (selectionChange)="onStatusSelectionChange()"
            >
              <mat-option
                *ngFor="let status of allProductStatuses"
                [value]="status"
              >
                {{ getProductStatusDisplayName(status) }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="status?.invalid && status?.errors?.required">
              {{ "validation.requiredField" | translate }}
            </mat-error>
            <mat-error *ngIf="status?.errors?.invalidInStockStatus">
              {{ "validation.invalidStatus" | translate }}
            </mat-error>
          </mat-form-field>
        </div>
        <div
          class="col-lg-1 col-md-1 col-2 d-flex align-items-start justify-content-center pt-2"
        >
          <!-- Emprty button space for design consistency -->
        </div>
      </div>
      <hr />
      <div class="row">
        <div class="col-12">
          <h2 class="quantity-header">{{ "inventory.amount" | translate }}</h2>
        </div>
      </div>
      <div class="row">
        <div class="quantity col-lg-4 col-md-4 col-4">
          <h4>{{ "common.coming" | translate }}</h4>
          <mat-form-field
            appearance="outline"
            class="product-variant-form-input"
          >
            <mat-label>{{ "inventory.quantityInStock" | translate }}</mat-label>
            <input
              matInput
              type="number"
              formControlName="quantityInStock"
              placeholder="{{ 'inventory.quantityInStock' | translate }}"
              min="0"
              required
              (input)="onQuantityInput()"
            />
            <mat-error
              *ngIf="quantityInStock?.invalid && quantityInStock?.touched"
            >
              <span *ngIf="quantityInStock?.errors?.required">
                {{ "validation.requiredField" | translate }}
              </span>
              <span *ngIf="quantityInStock?.errors?.min">
                {{ "validation.minValue" | translate : { value: 0 } }}
              </span>
            </mat-error></mat-form-field
          >
        </div>
        <div class="quantity col-lg-8 col-md-8 col-8">
          <h4>{{ "common.spending" | translate }}</h4>
          <div class="row">
            <div class="col-lg-6 col-md-6 col-6">
              <mat-form-field
                appearance="outline"
                class="product-variant-form-input"
              >
                <mat-label>{{ "common.drop" | translate }}</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="quantityDropSold"
                  placeholder="{{ 'inventory.quantityDropSold' | translate }}"
                  min="0"
                  required
                  (input)="onQuantityInput()"
                />
                <mat-error
                  *ngIf="quantityDropSold?.invalid && quantityDropSold?.touched"
                >
                  <span *ngIf="quantityDropSold?.errors?.required">
                    {{ "validation.requiredField" | translate }}
                  </span>
                  <span *ngIf="quantityDropSold?.errors?.min">
                    {{ "validation.minValue" | translate : { value: 0 } }}
                  </span>
                </mat-error></mat-form-field
              >
            </div>
            <div class="col-lg-6 col-md-6 col-6">
              <mat-form-field
                appearance="outline"
                class="product-variant-form-input"
              >
                <mat-label>{{ "common.my" | translate }}</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="quantityRegularSold"
                  placeholder="{{
                    'inventory.quantityRegularSold' | translate
                  }}"
                  min="0"
                  required
                  (input)="onQuantityInput()"
                />
                <mat-error
                  *ngIf="
                    quantityRegularSold?.invalid && quantityRegularSold?.touched
                  "
                >
                  <span *ngIf="quantityRegularSold?.errors?.required">
                    {{ "validation.requiredField" | translate }}
                  </span>
                  <span *ngIf="quantityRegularSold?.errors?.min">
                    {{ "validation.minValue" | translate : { value: 0 } }}
                  </span>
                </mat-error>
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>
      <hr />
      <div class="row">
        <div class="col-12">
          <mat-form-field
            appearance="outline"
            class="product-variant-form-input"
          >
            <mat-label>{{ "inventory.article" | translate }}</mat-label>
            <input
              matInput
              type="text"
              formControlName="article"
              placeholder="{{ 'inventory.article' | translate }}"
              required
            />
            <mat-error *ngIf="article?.invalid && article?.touched">
              {{ "validation.requiredField" | translate }}
            </mat-error></mat-form-field
          >
        </div>
      </div>

      <hr />
      <div class="row">
        <div class="col-12">
          <h4 class="photos-header mb-3">
            {{ "inventory.photos" | translate }}
            <span class="photo-count"
              >({{ getVisiblePhotos().length }}/{{ maxPhotos }})</span
            >
          </h4>
        </div>
      </div>

      <div class="row mb-3" *ngIf="canAddMorePhotos()">
        <div class="col-12">
          <input
            type="file"
            #photoInput
            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,image/heic,image/heif"
            multiple
            capture="environment"
            (change)="onPhotoFileSelected($event)"
            style="display: none"
          />
          <button
            type="button"
            mat-stroked-button
            color="primary"
            (click)="photoInput.click()"
            [disabled]="isUpdatingData"
            class="m-2"
          >
            <mat-icon>add_photo_alternate</mat-icon>
            {{ "inventory.uploadPhotos" | translate }}
          </button>
          <button
            type="button"
            mat-stroked-button
            class="ml-2"
            (click)="photoInputCamera.click()"
            [disabled]="isUpdatingData"
            class="m-2"
          >
            <mat-icon>camera_alt</mat-icon>
            {{ "inventory.takePhoto" | translate }}
          </button>
          <input
            type="file"
            #photoInputCamera
            accept="image/*"
            capture="environment"
            (change)="onPhotoFileSelected($event)"
            style="display: none"
          />
        </div>
      </div>

      <div class="row mb-3" *ngIf="photos.length > 0">
        <div class="col-12">
          <div class="photo-grid">
            <div
              *ngFor="let photo of photos; let i = index"
              class="photo-item"
              [class.marked-for-deletion]="photo.markedForDeletion"
            >
              <div class="photo-wrapper">
                <img
                  [src]="photo.photoUrl"
                  [alt]="'Photo ' + (i + 1)"
                  class="photo-thumbnail"
                />

                <button
                  *ngIf="!photo.markedForDeletion"
                  type="button"
                  mat-icon-button
                  class="delete-photo-btn"
                  (click)="onRemovePhoto(i)"
                  [matTooltip]="'common.delete' | translate"
                >
                  <mat-icon>close</mat-icon>
                </button>

                <div
                  class="photo-restore-overlay"
                  *ngIf="photo.markedForDeletion"
                >
                  <button
                    type="button"
                    mat-mini-fab
                    color="primary"
                    (click)="onRestorePhoto(i)"
                    [matTooltip]="'common.restore' | translate"
                  >
                    <mat-icon>undo</mat-icon>
                  </button>
                </div>

                <div class="photo-order-badge" *ngIf="!photo.markedForDeletion">
                  {{ i + 1 }}
                </div>

                <div
                  class="new-photo-badge"
                  *ngIf="!photo.isExisting && !photo.markedForDeletion"
                >
                  <mat-icon>fiber_new</mat-icon>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr />
      <div class="row">
        <div class="col-12">
          <h4 class="measurements-header">
            {{ "inventory.measurements" | translate }}
          </h4>
        </div>
      </div>

      <div class="row" formArrayName="measurements">
        <ng-container
          *ngFor="let measurementGroup of measurements.controls; let i = index"
        >
          <div class="col-lg-4 col-md-6 col-12 mb-3" [formGroupName]="i">
            <mat-form-field
              appearance="outline"
              class="w-100 product-variant-form-input"
            >
              <mat-label>
                {{ getMeasurementType(i)?.name }}
                <span *ngIf="getMeasurementType(i)?.unit"
                  >({{ getMeasurementType(i)?.unit }})</span
                >
              </mat-label>
              <input
                matInput
                type="number"
                formControlName="value"
                [placeholder]="getMeasurementType(i)?.name ?? ''"
                min="0"
                step="0.1"
                required
              />
              <mat-error
                *ngIf="
                  getMeasurementValueControl(i)?.invalid &&
                  getMeasurementValueControl(i)?.touched
                "
              >
                <span *ngIf="getMeasurementValueControl(i)?.errors?.required">
                  {{ "validation.requiredField" | translate }}
                </span>
                <span *ngIf="getMeasurementValueControl(i)?.errors?.min">
                  {{ "validation.minValue" | translate : { value: 0 } }}
                </span>
              </mat-error>
            </mat-form-field>
          </div>
        </ng-container>
      </div>
    </form>
  </ng-container>
</div>
<div mat-dialog-actions>
  <button
    mat-stroked-button
    color="warn"
    mat-dialog-close="false"
    [disabled]="isUpdatingData"
  >
    {{ "common.close" | translate }}
  </button>
  <button
    type="submit"
    mat-button
    [disabled]="!isFormValid() || isUpdatingData"
    (click)="onAddEditClick()"
  >
    <ng-container *ngIf="!isUpdatingData">
      <span *ngIf="data?.isAdding">{{ "common.add" | translate }}</span>
      <span *ngIf="!data?.isAdding">{{
        "common.update" | translate
      }}</span></ng-container
    >

    <div *ngIf="isUpdatingData" class="spinner-container">
      <mat-spinner diameter="20" color="accent"></mat-spinner>
      <span *ngIf="data?.isAdding" class="loading-text">{{
        "common.addingButtonText" | translate
      }}</span>
      <span *ngIf="!data?.isAdding" class="loading-text">{{
        "common.updatingButtonText" | translate
      }}</span>
    </div>
  </button>
</div>
