<div class="main container-fluid p-3">
  <div class="table-header">
    <div class="header-content">
      <div class="header-info">
        <h2 class="table-title">
          <mat-icon class="title-icon">
            <span class="material-symbols-outlined">order_approve</span>
          </mat-icon>
          {{ "orders.ordersHeader" | translate }}
        </h2>
      </div>
    </div>

    <div class="table-controls">
      <form [formGroup]="form" class="filter-form">
        <div class="form-row">
          <mat-form-field
            class="search-field form-control"
            appearance="outline"
          >
            <mat-label>{{ "orders.searchingOrders" | translate }}</mat-label>
            <input
              matInput
              formControlName="orderSearchString"
              placeholder="{{ 'orders.searchHelpText' | translate }}"
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field
            class="form-control status-field"
            appearance="outline"
          >
            <mat-label>{{ "orders.filters.statuses" | translate }}</mat-label>

            <mat-select formControlName="orderStatuses" multiple>
              <ng-container *ngIf="translatedAllOption$ | async as allLabel">
                <mat-option
                  [value]="ALL_STATUSES_VALUE"
                  (onSelectionChange)="onAllStatusesToggled($event)"
                >
                  {{ allLabel }}
                </mat-option></ng-container
              >

              <mat-divider></mat-divider>
              <mat-option *ngFor="let s of allOrderStatuses" [value]="s">
                {{ getOrderStatusTextKey(s) | translate }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>
    </div>

    <div class="info-row mt-3" *ngIf="!isRetrievingData">
      <div
        class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-3"
      >
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <button mat-mini-fab color="success" (click)="onAddOrderClick()">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <div class="total-items-text text-center">
          {{ "common.totalItems" | translate }}:
          {{ ordersResponse?.resultsAmount || 0 }}
        </div>
      </div>
    </div>
  </div>

  <div class="mat-elevation-z8 table-wrapper">
    <div class="mat-table-container">
      <table mat-table [dataSource]="dataSource" class="w-100 orders-table">
        <!-- Send until -->
        <ng-container matColumnDef="sendUntil">
          <th mat-header-cell *matHeaderCellDef>
            {{ "orders.table.sendUntil" | translate }}
          </th>
          <td mat-cell *matCellDef="let o">
            <span class="deadline" [ngClass]="getDeadlineClass(o)">
              {{ o.sendUntilDate | date: "shortDate" }}
            </span>
          </td>
        </ng-container>

        <!-- TTN -->
        <ng-container matColumnDef="ttn">
          <th mat-header-cell *matHeaderCellDef>
            {{ "orders.table.ttn" | translate }}
          </th>
          <td mat-cell *matCellDef="let o">
            <div class="cell-stack">
              <div class="ttn-row">
                <span class="ttn">{{
                  o.internetDocumentIntDocNumber || "—"
                }}</span>

                <button
                  *ngIf="shouldShowTtnWarning(o)"
                  mat-icon-button
                  class="ttn-warning"
                  type="button"
                  [matTooltip]="'orders.table.ttnNotCreated' | translate"
                  matTooltipPosition="above"
                  (click)="$event.stopPropagation()"
                  aria-label="TTN not created"
                >
                  <mat-icon>error</mat-icon>
                </button>
              </div>

              <span class="text-muted small d-md-none">
                {{ "orders.table.sendUntilShort" | translate }}:
                <span class="deadline" [ngClass]="getDeadlineClass(o)">
                  {{ o.sendUntilDate | date: "shortDate" }}
                </span>
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Items -->
        <ng-container matColumnDef="items">
          <th mat-header-cell *matHeaderCellDef>
            {{ "orders.table.items" | translate }}
          </th>

          <td mat-cell *matCellDef="let o">
            <div class="items-preview" *ngIf="getItemsPreview(o) as p">
              <div
                class="item-line"
                *ngFor="let it of p.preview; let last = last"
              >
                <div class="item-main">
                  <span class="item-title">{{ getItemTitle(it) }}</span>
                  <span class="item-qty">× {{ getItemQtyText(it) }}</span>
                </div>

                <div class="item-meta">
                  <span class="pill pill--custom" *ngIf="it.isCustomTailoring">
                    <mat-icon class="pill-icon">design_services</mat-icon>
                    {{ "orders.table.custom" | translate }}
                  </span>

                  <span
                    class="custom-comment"
                    *ngIf="it.isCustomTailoring && it.comment"
                  >
                    “{{ getCustomCommentShort(it.comment) }}”
                  </span>
                </div>

                <!-- divider -->
                <div class="item-divider" *ngIf="!last"></div>
              </div>

              <!-- more -->
              <div class="items-more" *ngIf="p.rest > 0">
                <mat-icon class="more-icon">more_horiz</mat-icon>
                <span class="more-text">+{{ p.rest }}</span>
                <span class="more-hint">
                  {{ "orders.table.openToSeeAll" | translate }}
                </span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Delivery -->
        <ng-container matColumnDef="delivery">
          <th mat-header-cell *matHeaderCellDef>
            {{ "orders.table.delivery" | translate }}
          </th>
          <td mat-cell *matCellDef="let o">
            <div class="cell-stack">
              <div>
                {{
                  o.recipientNpCity?.present ||
                    o.addressInfo?.recipientCity ||
                    "—"
                }}
              </div>
              <div class="text-muted small">
                <ng-container *ngIf="o.deliveryType === 0; else addressTpl">
                  {{ o.rcipientNpWarehouse?.description || "—" }}
                </ng-container>
                <ng-template #addressTpl>
                  {{ o.addressInfo?.recipientAddressName || "" }}
                  {{ o.addressInfo?.recipientHouse || "" }}
                  {{
                    o.addressInfo?.recipientFlat
                      ? "/" + o.addressInfo.recipientFlat
                      : ""
                  }}
                </ng-template>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>
            {{ "orders.table.status" | translate }}
          </th>
          <td mat-cell *matCellDef="let o">
            <div class="cell-stack" (click)="$event.stopPropagation()">
              <button
                mat-button
                class="status-btn"
                type="button"
                [matMenuTriggerFor]="statusMenu"
                #menuTrigger="matMenuTrigger"
                [disabled]="statusSaving.has(o.id)"
                (click)="onStatusBadgeClick(o, $event)"
              >
                <span
                  class="badge status-badge"
                  [ngClass]="getOrderStatusBadgeClass(o.orderStatus)"
                >
                  {{ getOrderStatusTextKey(o.orderStatus) | translate }}

                  <mat-icon
                    class="badge-spinner"
                    *ngIf="statusLoading.has(o.id)"
                    >autorenew</mat-icon
                  >
                  <mat-icon class="badge-arrow" *ngIf="!statusLoading.has(o.id)"
                    >expand_more</mat-icon
                  >
                </span>
              </button>
            </div>
          </td>
        </ng-container>

        <!-- Cost -->
        <ng-container matColumnDef="cost">
          <th mat-header-cell *matHeaderCellDef>
            {{ "orders.table.cost" | translate }}
          </th>
          <td mat-cell *matCellDef="let o">
            <div class="cell-stack">
              <div class="fw-600">{{ o.cost | number: "1.0-0" }}</div>
              <div class="text-muted small" *ngIf="o.afterpaymentOnGoodsCost">
                {{ "orders.table.afterpayment" | translate }}:
                {{ o.afterpaymentOnGoodsCost | number: "1.0-0" }}
              </div>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="row-clickable"
          (click)="openDetails(row)"
        ></tr>
      </table>

      <mat-menu #statusMenu="matMenu" xPosition="after" yPosition="below">
        <ng-container *ngIf="currentMenuOrder as o; else noOptionsTpl">
          <ng-container *ngIf="hasManualOptionsForCurrent(); else noOptionsTpl">
            <button
              mat-menu-item
              *ngFor="let st of currentManualOptions"
              (click)="setManualStatus(o, st, $event)"
            >
              <span class="badge" [ngClass]="getOrderStatusBadgeClass(st)">
                {{ getOrderStatusTextKey(st) | translate }}
              </span>
            </button>
          </ng-container>
        </ng-container>

        <ng-template #noOptionsTpl>
          <button mat-menu-item disabled>
            {{ "orders.status.noManualOptions" | translate }}
          </button>
        </ng-template>
      </mat-menu>
    </div>

    <div *ngIf="isRetrievingData">
      <app-spinner [diameter]="50"></app-spinner>
    </div>

    <mat-paginator
      [length]="ordersResponse?.resultsAmount || 0"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChanged($event)"
    ></mat-paginator>
  </div>
</div>
