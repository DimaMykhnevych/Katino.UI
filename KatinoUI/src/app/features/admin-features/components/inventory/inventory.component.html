<div class="main container-fluid p-3">
  <div class="table-header">
    <div class="header-content">
      <div class="header-info">
        <h2 class="table-title">
          <mat-icon class="title-icon">inventory</mat-icon>
          {{ "inventory.availability" | translate }}
        </h2>
      </div>
    </div>

    <div class="table-controls">
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>{{ "inventory.searchingProducts" | translate }}</mat-label>
        <input
          matInput
          (keyup)="applyFilter($event)"
          placeholder="{{ 'inventory.productName' | translate }}"
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>
  <div class="mat-elevation-z8 table-wrapper">
    <table mat-table matSort [dataSource]="dataSource" class="variants-table">
      <ng-container matColumnDef="product">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          class="text-center"
        >
          {{ "inventory.product" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <div class="color-size-cell">
            <div>
              <span class="product-name">{{ variant.product.name }}</span>
            </div>
            <div class="color-size-cell-content">
              <div class="color-info">
                <div
                  class="color-swatch"
                  [style.background-color]="variant.color.hexCode"
                  [matTooltip]="variant.color.name"
                ></div>
              </div>
              <div class="size-info">
                <span
                  class="size-badge"
                  [class.letter-size]="variant.size.type === 1"
                >
                  {{ variant.size.name }}
                </span>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="productPhoto">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.photo" | translate }}
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          [class.remove-bottom-border]="!variant.isLastInGroup"
        >
          <img
            src="https://t3.ftcdn.net/jpg/04/83/25/50/360_F_483255019_m1r1ujM8EOkr8PamCHF85tQ0rHG3Fiqz.jpg"
            width="100"
            height="100"
            *ngIf="variant.showProductInfo"
          />
        </td>
      </ng-container>

      <ng-container matColumnDef="availability">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.availability" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <div>
            <span>{{
              variant.quantityInStock -
                variant.quantityDropSold -
                variant.quantityRegularSold
            }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="productStatus">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.status" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <div>
            <span [class]="getProductStatusClass(variant.status)">{{
              getProductStatusDisplayName(variant.status)
            }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="measurements">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="text-center collapsible-header"
          (click)="toggleMeasurementsColumn()"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.measurements" | translate }}</span>
            <mat-icon class="collapse-icon">expand_less</mat-icon>
          </div>
          <div class="measurements-header-collapsed" *ngIf="isHeadersCollapsed">
            <mat-icon class="collapse-icon">expand_more</mat-icon>
          </div>
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-content" *ngIf="!isHeadersCollapsed">
            <div
              class="measurement-item p-2"
              *ngFor="let measurement of variant.measurements"
            >
              <span class="measurement-name"
                >{{ measurement.measurementType.name }}:</span
              >
              <span class="measurement-value"
                >{{ measurement.value
                }}{{ measurement.measurementType.unit }}</span
              >
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="prices">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="text-center collapsible-header-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.prices" | translate }}</span>
          </div>
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell-secondary"
          [class.collapsed]="isHeadersCollapsed"
          [class.remove-bottom-border]="!variant.isLastInGroup"
        >
          <div
            class="collapsible-content p-2"
            *ngIf="!isHeadersCollapsed && variant.showProductInfo"
          >
            <div>
              <span>{{ "inventory.costPrice" | translate }}:</span>
              <span>{{ variant.product.costPrice }}₴</span>
            </div>
            <div>
              <span>{{ "inventory.dropPrice" | translate }}:</span>
              <span>{{ variant.product.dropPrice }}₴</span>
            </div>
            <div>
              <span>{{ "inventory.wholesalePrice" | translate }}:</span>
              <span>{{ variant.product.wholesalePrice }}₴</span>
            </div>
            <div>
              <span>{{ "inventory.price" | translate }}:</span>
              <span>{{ variant.product.price }}₴</span>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="amount">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="text-center collapsible-header-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.amount" | translate }}</span>
          </div>
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-content p-2" *ngIf="!isHeadersCollapsed">
            <div>
              <span>{{ "inventory.quantityInStock" | translate }}:</span>
              <span>{{ variant.quantityInStock }}</span>
            </div>
            <div>
              <span>{{ "inventory.quantityDropSold" | translate }}:</span>
              <span>{{ variant.quantityDropSold }}</span>
            </div>
            <div>
              <span>{{ "inventory.quantityRegularSold" | translate }}:</span>
              <span>{{ variant.quantityRegularSold }}</span>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="article">
        <th
          class="article text-center collapsible-header-secondary"
          [class.collapsed]="isHeadersCollapsed"
          mat-header-cell
          *matHeaderCellDef
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.article" | translate }}</span>
          </div>
        </th>
        <td
          class="article"
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div
            class="article-cell collapsible-content"
            *ngIf="!isHeadersCollapsed"
          >
            <span class="article-code">{{ variant.article }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.actions" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item>
              <mat-icon>info</mat-icon>
              <span>{{ "inventory.info" | translate }}</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        class="variant-row"
      ></tr>
    </table>

    <div *ngIf="isRetrievingProductVariants">
      <app-spinner [diameter]="50"></app-spinner>
    </div>

    <mat-paginator [pageSizeOptions]="[1000, 5, 10, 20]" showFirstLastButtons>
    </mat-paginator>
  </div>
</div>
