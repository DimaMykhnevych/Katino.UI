<div class="main container-fluid p-3">
  <div class="table-header">
    <div class="header-content">
      <div class="header-info">
        <h2 class="table-title">
          <mat-icon class="title-icon">inventory</mat-icon>
          {{ "inventory.availability" | translate }}
        </h2>
      </div>
    </div>

    <div class="table-controls">
      <form [formGroup]="form" class="filter-form">
        <div class="form-row">
          <mat-form-field
            class="search-field form-control"
            appearance="outline"
          >
            <mat-label>{{
              "inventory.searchingProducts" | translate
            }}</mat-label>
            <input
              matInput
              formControlName="productName"
              placeholder="{{ 'inventory.productName' | translate }}"
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-control">
            <mat-label>{{ "inventory.category" | translate }}</mat-label>
            <mat-select formControlName="categoryId">
              <ng-container *ngIf="translatedAllOption$ | async as allLabel">
                <mat-option [value]="allSelectionOptionId">
                  {{ allLabel }}
                </mat-option>
              </ng-container>

              <mat-option
                *ngFor="let category of categoriesResponse?.categories"
                [value]="category.id"
              >
                {{ category.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-control">
            <mat-label>{{ "inventory.status" | translate }}</mat-label>
            <mat-select formControlName="productStatus">
              <ng-container *ngIf="translatedAllOption$ | async as allLabel">
                <mat-option [value]="allSelectionOptionId">
                  {{ allLabel }}
                </mat-option>
              </ng-container>

              <mat-option
                *ngFor="let status of allProductStatuses"
                [value]="status"
              >
                {{ getProductStatusDisplayName(status) }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>
    </div>
    <div
      class="info-row d-flex justify-content-between align-items-center mt-3"
      *ngIf="!isRetrievingData"
    >
      <div>
        <button
          mat-mini-fab
          color="success"
          (click)="onAddProductVariantClick()"
        >
          <mat-icon>add</mat-icon>
        </button>
      </div>
      <div class="total-items-text">
        {{ "common.totalItems" | translate }}:
        {{ productVariantResponse?.resultsAmount }}
      </div>
    </div>
  </div>
  <div class="mat-elevation-z8 table-wrapper">
    <table mat-table matSort [dataSource]="dataSource" class="variants-table">
      <ng-container matColumnDef="product">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          class="text-center"
        >
          {{ "inventory.product" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <div class="color-size-cell">
            <div>
              <span class="product-name">{{ variant.product.name }}</span>
            </div>
            <div class="color-size-cell-content">
              <div class="color-info">
                <div
                  class="color-swatch"
                  [style.background-color]="variant.color.hexCode"
                  [matTooltip]="variant.color.name"
                ></div>
              </div>
              <div class="size-info">
                <span
                  class="size-badge"
                  [class.letter-size]="variant.size.type === 1"
                >
                  {{ variant.size.name }}
                </span>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="productPhoto">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.photo" | translate }}
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          [class.remove-bottom-border]="!variant.isLastInGroup"
        >
          <img
            [src]="variant.photos[0]?.photoUrl ?? placeholderImageUrl"
            width="80"
            height="90"
            class="product-thumbnail"
            (click)="openLargeImage(variant.photos, 0)"
            [alt]="variant.product.name"
          />
        </td>
      </ng-container>

      <ng-container matColumnDef="availability">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.availability" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <div>
            <span>{{
              variant.quantityInStock -
                variant.quantityDropSold -
                variant.quantityRegularSold <
              0
                ? 0
                : variant.quantityInStock -
                  variant.quantityDropSold -
                  variant.quantityRegularSold
            }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="productStatus">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.status" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <div>
            <span [class]="getProductStatusClass(variant.status)">{{
              getProductStatusDisplayName(variant.status)
            }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="measurements">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="text-center collapsible-header"
          (click)="toggleMeasurementsColumn()"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.measurements" | translate }}</span>
            <mat-icon class="collapse-icon">expand_less</mat-icon>
          </div>
          <div class="measurements-header-collapsed" *ngIf="isHeadersCollapsed">
            <mat-icon class="collapse-icon">expand_more</mat-icon>
          </div>
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-content" *ngIf="!isHeadersCollapsed">
            <div
              class="measurement-item p-2"
              *ngFor="let measurement of variant.measurements"
            >
              <span class="measurement-name"
                >{{ measurement.measurementType.name }}:</span
              >
              <span class="measurement-value"
                >{{ measurement.value
                }}{{ measurement.measurementType.unit }}</span
              >
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="prices">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="text-center collapsible-header-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.prices" | translate }}</span>
          </div>
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell-secondary"
          [class.collapsed]="isHeadersCollapsed"
          [class.remove-bottom-border]="!variant.isLastInGroup"
        >
          <div
            class="collapsible-content p-2"
            *ngIf="!isHeadersCollapsed && variant.showProductInfo"
          >
            <div>
              <span>{{ "inventory.costPrice" | translate }}:</span>
              <span>{{ variant.product.costPrice }}₴</span>
            </div>
            <div>
              <span>{{ "inventory.dropPrice" | translate }}:</span>
              <span>{{ variant.product.dropPrice }}₴</span>
            </div>
            <div>
              <span>{{ "inventory.wholesalePrice" | translate }}:</span>
              <span>{{ variant.product.wholesalePrice }}₴</span>
            </div>
            <div>
              <span>{{ "inventory.price" | translate }}:</span>
              <span>{{ variant.product.price }}₴</span>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="amount">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="text-center collapsible-header-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.amount" | translate }}</span>
          </div>
        </th>
        <td
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div class="collapsible-content p-2" *ngIf="!isHeadersCollapsed">
            <div>
              <span>{{ "inventory.quantityInStock" | translate }}:</span>
              <span>{{ variant.quantityInStock }}</span>
            </div>
            <div>
              <span>{{ "inventory.quantityDropSold" | translate }}:</span>
              <span>{{ variant.quantityDropSold }}</span>
            </div>
            <div>
              <span>{{ "inventory.quantityRegularSold" | translate }}:</span>
              <span>{{ variant.quantityRegularSold }}</span>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="article">
        <th
          class="article text-center collapsible-header-secondary"
          [class.collapsed]="isHeadersCollapsed"
          mat-header-cell
          *matHeaderCellDef
        >
          <div class="collapsible-header-content" *ngIf="!isHeadersCollapsed">
            <span>{{ "inventory.article" | translate }}</span>
          </div>
        </th>
        <td
          class="article"
          mat-cell
          *matCellDef="let variant"
          class="collapsible-cell-secondary"
          [class.collapsed]="isHeadersCollapsed"
        >
          <div
            class="article-cell collapsible-content"
            *ngIf="!isHeadersCollapsed"
          >
            <span class="article-code">{{ variant.article }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ "inventory.actions" | translate }}
        </th>
        <td mat-cell *matCellDef="let variant">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="onEditClick(variant)">
              <mat-icon>edit</mat-icon>
              <span>{{ "common.update" | translate }}</span>
            </button>
            <button mat-menu-item (click)="onDeleteClick(variant)">
              <mat-icon>delete</mat-icon>
              <span>{{ "common.delete" | translate }}</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        class="variant-row"
      ></tr>
    </table>

    <div *ngIf="isRetrievingData">
      <app-spinner [diameter]="50"></app-spinner>
    </div>

    <mat-paginator [pageSizeOptions]="[1000, 5, 10, 20]" showFirstLastButtons>
    </mat-paginator>
  </div>
</div>

<div class="photo-overlay" *ngIf="showLargeImage" (click)="closeLargeImage()">
  <img
    [src]="selectedImageUrl"
    class="large-photo"
    (click)="$event.stopPropagation()"
  />

  <button
    *ngIf="hasMultiplePhotos"
    class="nav-btn prev-btn"
    (click)="previousPhoto($event)"
    aria-label="Previous photo"
  >
    <mat-icon>chevron_left</mat-icon>
  </button>

  <button
    *ngIf="hasMultiplePhotos"
    class="nav-btn next-btn"
    (click)="nextPhoto($event)"
    aria-label="Next photo"
  >
    <mat-icon>chevron_right</mat-icon>
  </button>

  <div class="photo-counter" *ngIf="hasMultiplePhotos">
    {{ photoCounter }}
  </div>

  <button class="close-btn" (click)="closeLargeImage()">×</button>
</div>
