<div class="main container-fluid p-3">
  <div class="table-header">
    <div class="header-content">
      <div class="header-info">
        <h2 class="table-title">
          <mat-icon class="title-icon">checkroom</mat-icon>
          {{ "sewingQueue.sewingQueueHeader" | translate }}
        </h2>

        <div class="table-subtitle">
          {{ "common.totalItems" | translate }}: {{ resultsAmount }}
        </div>
      </div>
    </div>
  </div>

  <div class="mat-elevation-z8 table-wrapper p-0">
    <div class="loading" *ngIf="isLoading">
      <mat-spinner diameter="32"></mat-spinner>
      <div class="text-muted mt-2">{{ "common.loading" | translate }}</div>
    </div>

    <div class="empty" *ngIf="!isLoading && dataSource.data.length === 0">
      <mat-icon class="empty-icon">task_alt</mat-icon>
      <div class="empty-title">{{ "sewingQueue.emptyTitle" | translate }}</div>
      <div class="empty-subtitle">
        {{ "sewingQueue.emptySubtitle" | translate }}
      </div>
    </div>

    <div
      class="mat-table-container"
      *ngIf="!isLoading && dataSource.data.length > 0"
    >
      <table mat-table [dataSource]="dataSource" class="w-100 sewing-table">
        <!-- Product -->
        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef>
            {{ "sewingQueue.table.product" | translate }}
          </th>

          <td mat-cell *matCellDef="let row">
            <div class="cell-stack">
              <div class="product-title">{{ productTitle(row) }}</div>

              <div class="text-muted small">
                <span class="article" *ngIf="row.productVariant?.article">
                  #{{ row.productVariant.article }}
                </span>
              </div>

              <!-- mobile: show comment if exists -->
              <div class="comment mobile-only" *ngIf="row.comment">
                <mat-icon class="comment-icon">chat</mat-icon>
                <span>{{ row.comment }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- To produce -->
        <ng-container matColumnDef="toProduce">
          <th mat-header-cell *matHeaderCellDef class="text-end">
            {{ "sewingQueue.table.toProduce" | translate }}
          </th>
          <td mat-cell *matCellDef="let row" class="text-end">
            <span class="qty-pill">{{ row.quantityToProduce }}</span>
          </td>
        </ng-container>

        <!-- Custom -->
        <ng-container matColumnDef="custom">
          <th mat-header-cell *matHeaderCellDef>
            {{ "sewingQueue.table.custom" | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            <div class="cell-stack">
              <span
                class="badge"
                [class.badge-custom]="row.isCustomTailoring"
                [class.badge-regular]="!row.isCustomTailoring"
              >
                <mat-icon class="badge-icon">{{
                  row.isCustomTailoring ? "star" : "check"
                }}</mat-icon>
                {{
                  row.isCustomTailoring
                    ? ("sewingQueue.labels.custom" | translate)
                    : ("sewingQueue.labels.regular" | translate)
                }}
              </span>

              <div class="comment desktop-only" *ngIf="row.comment">
                <mat-icon class="comment-icon">chat</mat-icon>
                <span>{{ row.comment }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Mobile Info (one column) -->
        <ng-container matColumnDef="info">
          <th mat-header-cell *matHeaderCellDef>
            {{ "sewingQueue.table.product" | translate }}
          </th>

          <td mat-cell *matCellDef="let row">
            <div class="m-info">
              <div class="m-title">{{ productTitle(row) }}</div>

              <div class="m-meta">
                <span
                  class="badge"
                  [class.badge-custom]="row.isCustomTailoring"
                  [class.badge-regular]="!row.isCustomTailoring"
                >
                  <mat-icon class="badge-icon">{{
                    row.isCustomTailoring ? "star" : "check"
                  }}</mat-icon>
                  {{
                    row.isCustomTailoring
                      ? ("sewingQueue.labels.custom" | translate)
                      : ("sewingQueue.labels.regular" | translate)
                  }}
                </span>

                <span class="m-qty">
                  {{ "sewingQueue.table.toProduce" | translate }}:
                  <b>{{ row.quantityToProduce }}</b>
                </span>
              </div>

              <div class="m-comment" *ngIf="row.comment">
                <mat-icon class="comment-icon">chat</mat-icon>
                <span>{{ row.comment }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Actual -->
        <ng-container matColumnDef="actual">
          <th mat-header-cell *matHeaderCellDef class="text-end">
            {{ "sewingQueue.table.actual" | translate }}
          </th>
          <td mat-cell *matCellDef="let row" class="text-end">
            <input
              matInput
              type="number"
              class="actual-input"
              [formControl]="getActualControl(row)"
              min="1"
              [attr.max]="row.isCustomTailoring ? row.quantityToProduce : null"
              [class.invalid]="
                getActualControl(row).invalid && getActualControl(row).touched
              "
              [placeholder]="'sewingQueue.placeholders.actual' | translate"
            />
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let row" class="text-end">
            <button
              mat-icon-button
              color="primary"
              class="submit-btn"
              [disabled]="!canSubmit(row)"
              (click)="submitRow(row)"
            >
              <mat-icon *ngIf="!submitting.has(getRowKey(row))">done</mat-icon>
              <mat-spinner
                *ngIf="submitting.has(getRowKey(row))"
                diameter="18"
              ></mat-spinner>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="row-separator"
        ></tr>
      </table>
    </div>
  </div>

  <!-- GROUPED CARDS -->
  <div class="mat-elevation-z8 table-wrapper p-3 mt-3 grouped-wrapper">
    <div class="grouped-header">
      <div>
        <div class="grouped-title">
          {{ "sewingQueue.grouped.title" | translate }}
        </div>
        <div class="grouped-subtitle">
          {{ "sewingQueue.grouped.subtitle" | translate }}
        </div>
      </div>

      <button
        mat-stroked-button
        color="primary"
        (click)="loadGrouped()"
        [disabled]="isGroupedLoading"
      >
        <mat-icon>refresh</mat-icon>
        {{ "common.refresh" | translate }}
      </button>
    </div>

    <div class="loading" *ngIf="isGroupedLoading">
      <mat-spinner diameter="28"></mat-spinner>
    </div>

    <div class="empty" *ngIf="!isGroupedLoading && grouped.length === 0">
      <div class="empty-title">
        {{ "sewingQueue.grouped.emptyTitle" | translate }}
      </div>
    </div>

    <div class="grouped-grid" *ngIf="!isGroupedLoading && grouped.length > 0">
      <div
        class="group-card"
        *ngFor="let g of grouped"
        [ngClass]="groupCardClass(g)"
      >
        <div class="group-card-head">
          <div class="date">
            {{ g.sendUntilDate | date: "dd.MM.yyyy" }}
          </div>

          <div class="pill">
            {{ "sewingQueue.grouped.items" | translate }}:
            {{ g.items.length || 0 }}
          </div>
        </div>

        <div class="group-items">
          <div class="g-item" *ngFor="let row of g.items">
            <div class="g-name">{{ productTitle(row) }}</div>

            <div class="g-meta">
              <span
                class="mini-badge"
                [class.mb-custom]="row.isCustomTailoring"
                [class.mb-regular]="!row.isCustomTailoring"
              >
                {{
                  row.isCustomTailoring
                    ? ("sewingQueue.labels.custom" | translate)
                    : ("sewingQueue.labels.regular" | translate)
                }}
              </span>

              <span class="g-qty">
                {{ "sewingQueue.table.toProduce" | translate }}:
                <b>{{ row.quantityToProduce }}</b>
              </span>
            </div>

            <div class="g-comment" *ngIf="row.comment">
              <mat-icon class="comment-icon">chat</mat-icon>
              <span>{{ row.comment }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
