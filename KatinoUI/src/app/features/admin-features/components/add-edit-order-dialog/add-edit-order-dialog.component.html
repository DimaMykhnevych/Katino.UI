<h1 mat-dialog-title>
  <div *ngIf="data.isAdding">
    {{ "orders.addingOrder.dialogTitle" | translate }}
  </div>
  <div *ngIf="!data.isAdding">
    {{ "orders.updatingOrder.dialogTitle" | translate }}
  </div>
</h1>
<div mat-dialog-content class="main">
  <ng-container
    ><form [formGroup]="form">
      <div class="row mb-3">
        <div class="col-12">
          <div class="section">
            <div class="section-title">
              {{ "orders.sections.delivery" | translate }}
            </div>

            <div class="kv">
              <div class="k d-flex align-items-center">
                {{ "orders.labels.deliveryType" | translate }}
              </div>
              <div class="v">
                <mat-radio-group
                  aria-label="Select an option"
                  formControlName="deliveryType"
                  required
                  color="primary"
                >
                  <mat-radio-button
                    *ngFor="let opt of deliveryTypeOptions"
                    [value]="opt.value"
                    class="p-1"
                  >
                    {{ opt.labelKey | translate }}
                  </mat-radio-button>
                </mat-radio-group>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="section">
            <div class="section-title">
              {{ "orders.sections.recipient" | translate }}
            </div>

            <div class="row">
              <div class="col-12">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.instUrl" | translate
                  }}</mat-label>
                  <input matInput formControlName="instUrl" required />
                  <mat-error
                    *ngIf="instUrl?.touched && instUrl?.hasError('required')"
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Phone -->
              <div class="col-12 col-md-6">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.recipientPhone" | translate
                  }}</mat-label>

                  <input
                    matInput
                    formControlName="recipientPhones"
                    [matAutocomplete]="autoPhones"
                    placeholder="380660000000"
                    autocomplete="off"
                    required
                  />

                  <mat-autocomplete
                    #autoPhones="matAutocomplete"
                    autoActiveFirstOption
                    (optionSelected)="onPhoneOptionSelected($event)"
                  >
                    <mat-option *ngFor="let p of phoneSuggestions" [value]="p">
                      <div class="option-two-lines">
                        <div class="option-primary">{{ p.phones }}</div>
                        <div class="option-secondary">
                          {{ p.lastName }} {{ p.firstName }} {{ p.middleName }}
                        </div>
                      </div>
                    </mat-option>
                  </mat-autocomplete>

                  <mat-hint *ngIf="isSearchingPhones">
                    {{ "orders.hints.searchingPhones" | translate }}
                  </mat-hint>

                  <mat-error
                    *ngIf="
                      recipientPhones?.touched &&
                      recipientPhones?.hasError('required')
                    "
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                  <mat-error
                    *ngIf="
                      recipientPhones?.touched &&
                      recipientPhones?.hasError('pattern')
                    "
                  >
                    {{ "orders.validation.phoneFormat" | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Last name -->
              <div class="col-12 col-md-6">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.recipientLastName" | translate
                  }}</mat-label>
                  <input
                    matInput
                    formControlName="recipientLastName"
                    required
                  />
                  <mat-error
                    *ngIf="
                      recipientLastName?.touched &&
                      recipientLastName?.hasError('required')
                    "
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- First name -->
              <div class="col-12 col-md-6">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.recipientFirstName" | translate
                  }}</mat-label>
                  <input
                    matInput
                    formControlName="recipientFirstName"
                    required
                  />
                  <mat-error
                    *ngIf="
                      recipientFirstName?.touched &&
                      recipientFirstName?.hasError('required')
                    "
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Middle name -->
              <div class="col-12 col-md-6">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.recipientMiddleName" | translate
                  }}</mat-label>
                  <input matInput formControlName="recipientMiddleName" />
                  <mat-error
                    *ngIf="
                      recipientMiddleName?.touched &&
                      recipientMiddleName?.hasError('required')
                    "
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="section">
            <div class="section-title">
              {{ "orders.sections.deliveryAddress" | translate }}
            </div>

            <ng-container
              *ngIf="
                deliveryType?.value === DeliveryType.address;
                else warehouseTpl
              "
            >
              <div class="row" [formGroup]="addressInfoGroup">
                <div class="col-12 col-md-6">
                  <mat-form-field class="order-form-input" appearance="outline">
                    <mat-label>{{
                      "orders.address.city" | translate
                    }}</mat-label>
                    <input matInput formControlName="recipientCity" required />
                    <mat-error
                      *ngIf="
                        addressInfoGroup.get('recipientCity')?.touched &&
                        addressInfoGroup
                          .get('recipientCity')
                          ?.hasError('required')
                      "
                    >
                      {{ "validation.requiredField" | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="order-form-input" appearance="outline">
                    <mat-label>{{
                      "orders.address.addressName" | translate
                    }}</mat-label>
                    <input
                      matInput
                      formControlName="recipientAddressName"
                      required
                    />
                    <mat-error
                      *ngIf="
                        addressInfoGroup.get('recipientAddressName')?.touched &&
                        addressInfoGroup
                          .get('recipientAddressName')
                          ?.hasError('required')
                      "
                    >
                      {{ "validation.requiredField" | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="order-form-input" appearance="outline">
                    <mat-label>{{
                      "orders.address.house" | translate
                    }}</mat-label>
                    <input matInput formControlName="recipientHouse" required />
                    <mat-error
                      *ngIf="
                        addressInfoGroup.get('recipientHouse')?.touched &&
                        addressInfoGroup
                          .get('recipientHouse')
                          ?.hasError('required')
                      "
                    >
                      {{ "validation.requiredField" | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12 col-md-6">
                  <mat-form-field class="order-form-input" appearance="outline">
                    <mat-label>{{
                      "orders.address.flat" | translate
                    }}</mat-label>
                    <input matInput formControlName="recipientFlat" required />
                    <mat-error
                      *ngIf="
                        addressInfoGroup.get('recipientFlat')?.touched &&
                        addressInfoGroup
                          .get('recipientFlat')
                          ?.hasError('required')
                      "
                    >
                      {{ "validation.requiredField" | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="col-12">
                  <mat-form-field class="order-form-input" appearance="outline">
                    <mat-label>{{
                      "orders.address.note" | translate
                    }}</mat-label>
                    <input matInput formControlName="recipientAddressNote" />
                  </mat-form-field>
                </div>
              </div>
            </ng-container>

            <!-- Warehouse/Postomat delivery -->
            <ng-template #warehouseTpl>
              <app-np-warehouse-selection
                [initialCity]="initialRecipientCity"
                [initialWarehouse]="initialRecipientWarehouse"
                (valueChanged)="onRecipientWarehouseChanged($event)"
              ></app-np-warehouse-selection>
            </ng-template>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="section">
            <div class="section-title">
              {{ "orders.sections.items" | translate }}
            </div>

            <mat-form-field class="order-form-input" appearance="outline">
              <mat-label>{{
                "orders.labels.addProduct" | translate
              }}</mat-label>
              <input
                matInput
                [formControl]="productSearchCtrl"
                [matAutocomplete]="productAuto"
              />
              <mat-autocomplete
                #productAuto="matAutocomplete"
                [displayWith]="displayProductVariant"
                (optionSelected)="onProductSelected($event.option.value)"
              >
                <mat-option *ngFor="let pv of productVariants" [value]="pv">
                  <div class="d-flex flex-column">
                    <strong>{{ pv.product.name }}</strong>
                    <small class="text-muted">
                      {{ pv.color.name }} • {{ pv.size.name }}
                    </small>
                  </div>
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>

            <div class="table-responsive" *ngIf="orderItems.length">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>{{ "orders.items.product" | translate }}</th>
                    <th class="text-center">
                      {{ "orders.items.custom" | translate }}
                    </th>
                    <th>{{ "orders.items.comment" | translate }}</th>
                    <th class="text-end">
                      {{ "orders.items.qty" | translate }}
                    </th>
                    <th></th>
                  </tr>
                </thead>

                <tbody>
                  <tr
                    *ngFor="let item of orderItemGroups; let i = index"
                    [formGroup]="item"
                  >
                    <td>
                      <div>
                        <strong>
                          {{ item.value.productVariant.product.name }}
                        </strong>
                        <div class="text-muted small">
                          {{ item.value.productVariant.color.name }} •
                          {{ item.value.productVariant.size.name }}
                        </div>
                      </div>
                    </td>

                    <td class="text-center">
                      <mat-checkbox
                        color="primary"
                        formControlName="isCustomTailoring"
                      ></mat-checkbox>
                    </td>

                    <td>
                      <input
                        matInput
                        formControlName="comment"
                        placeholder="{{ 'orders.items.comment' | translate }}"
                      />
                    </td>

                    <td class="text-end">
                      <input
                        matInput
                        type="number"
                        formControlName="quantity"
                        min="1"
                        class="qty-input"
                        [class.invalid]="
                          item.get('quantity')?.invalid &&
                          item.get('quantity')?.touched
                        "
                      />
                    </td>

                    <td class="text-end">
                      <button
                        mat-icon-button
                        color="warn"
                        (click)="orderItems.removeAt(i)"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="section">
            <div class="section-title">
              {{ "orders.sections.pricing" | translate }}
            </div>

            <!-- Sale type -->
            <div class="kv mb-2">
              <div class="k d-flex align-items-center">
                {{ "orders.labels.saleType" | translate }}
              </div>
              <div class="v">
                <mat-radio-group formControlName="saleType" color="primary">
                  <mat-radio-button [value]="SaleType.retail" class="p-1">
                    {{ "orders.saleType.retail" | translate }}
                  </mat-radio-button>
                  <mat-radio-button [value]="SaleType.drop" class="p-1">
                    {{ "orders.saleType.drop" | translate }}
                  </mat-radio-button>
                  <mat-radio-button [value]="SaleType.wholesale" class="p-1">
                    {{ "orders.saleType.wholesale" | translate }}
                  </mat-radio-button>
                </mat-radio-group>

                <div class="text-muted small" *ngIf="!data.isAdding">
                  {{ "orders.hints.saleTypeLocked" | translate }}
                </div>
              </div>
            </div>

            <!-- Total cost + prepayment -->
            <div class="row g-2 align-items-end">
              <div class="col-12">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.totalCost" | translate
                  }}</mat-label>
                  <input
                    matInput
                    type="number"
                    min="1"
                    formControlName="cost"
                  />
                  <mat-error
                    *ngIf="cost?.touched && cost?.hasError('required')"
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                  <mat-error *ngIf="cost?.touched && cost?.hasError('min')">
                    {{ "validation.mustBeGreaterThanZero" | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="col-12">
                <mat-checkbox formControlName="isPrepayment" color="primary">
                  {{ "orders.labels.prepayment" | translate }}
                </mat-checkbox>
              </div>

              <div class="col-12" *ngIf="isPrepayment?.value === true">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.afterpayment" | translate
                  }}</mat-label>
                  <input
                    matInput
                    type="number"
                    min="1"
                    formControlName="afterpaymentOnGoodsCost"
                  />
                  <mat-error
                    *ngIf="
                      afterpaymentOnGoodsCost?.touched &&
                      afterpaymentOnGoodsCost?.hasError('required')
                    "
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                  <mat-error
                    *ngIf="
                      afterpaymentOnGoodsCost?.touched &&
                      afterpaymentOnGoodsCost?.hasError('min')
                    "
                  >
                    {{ "validation.mustBeGreaterThanZero" | translate }}
                  </mat-error>
                </mat-form-field>

                <div class="text-muted small">
                  {{
                    "orders.hints.afterpaymentDefault"
                      | translate: { amount: PREPAYMENT_AMOUNT }
                  }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="section">
            <div class="section-title">
              {{ "orders.sections.seat" | translate }}
            </div>

            <div class="row" [formGroup]="seatGroup">
              <!-- Weight -->
              <div class="col-12 col-md-3">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{ "orders.seat.weight" | translate }}</mat-label>
                  <mat-select formControlName="weight" required>
                    <mat-option *ngFor="let w of seatWeightOptions" [value]="w">
                      {{ w }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- Length -->
              <div class="col-12 col-md-3">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{ "orders.seat.length" | translate }}</mat-label>
                  <input
                    matInput
                    type="number"
                    min="1"
                    formControlName="volumetricLength"
                    required
                  />
                </mat-form-field>
              </div>

              <!-- Width -->
              <div class="col-12 col-md-3">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{ "orders.seat.width" | translate }}</mat-label>
                  <input
                    matInput
                    type="number"
                    min="1"
                    formControlName="volumetricWidth"
                    required
                  />
                </mat-form-field>
              </div>

              <!-- Height -->
              <div class="col-12 col-md-3">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{ "orders.seat.height" | translate }}</mat-label>
                  <input
                    matInput
                    type="number"
                    min="1"
                    formControlName="volumetricHeight"
                    required
                  />
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="section">
            <div class="section-title">
              {{ "orders.sections.orderInfo" | translate }}
            </div>

            <div class="row">
              <div class="col-12 col-md-6">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.sendUntilDate" | translate
                  }}</mat-label>
                  <input
                    matInput
                    [matDatepicker]="picker"
                    formControlName="sendUntilDate"
                    required
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="picker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #picker></mat-datepicker>

                  <mat-error
                    *ngIf="
                      sendUntilDate?.touched &&
                      sendUntilDate?.hasError('required')
                    "
                  >
                    {{ "validation.requiredField" | translate }}
                  </mat-error>
                  <mat-error
                    *ngIf="
                      sendUntilDate?.touched &&
                      sendUntilDate?.hasError('dateInPast')
                    "
                  >
                    {{ "orders.validation.sendUntilDateNotPast" | translate }}
                  </mat-error>
                  <mat-error
                    *ngIf="
                      sendUntilDate?.touched &&
                      sendUntilDate?.hasError('invalidDate')
                    "
                  >
                    {{ "orders.validation.invalidDate" | translate }}
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="col-12">
                <mat-form-field class="order-form-input" appearance="outline">
                  <mat-label>{{
                    "orders.labels.description" | translate
                  }}</mat-label>
                  <textarea
                    matInput
                    formControlName="description"
                    rows="3"
                  ></textarea>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </div></form
  ></ng-container>
</div>
<div mat-dialog-actions>
  <button
    mat-stroked-button
    color="warn"
    [mat-dialog-close]="false"
    [disabled]="isUpdatingData"
  >
    {{ "common.close" | translate }}
  </button>
  <button
    type="submit"
    mat-button
    [disabled]="!isFormValid() || isUpdatingData"
    (click)="onAddEditOrderClick()"
  >
    <ng-container *ngIf="!isUpdatingData">
      <span *ngIf="data.isAdding">{{ "common.add" | translate }}</span>
      <span *ngIf="!data.isAdding">{{
        "common.update" | translate
      }}</span></ng-container
    >

    <div *ngIf="isUpdatingData" class="spinner-container">
      <mat-spinner diameter="20" color="accent"></mat-spinner>
      <span *ngIf="data.isAdding" class="loading-text">{{
        "common.addingButtonText" | translate
      }}</span>
      <span *ngIf="!data.isAdding" class="loading-text">{{
        "common.updatingButtonText" | translate
      }}</span>
    </div>
  </button>
</div>
